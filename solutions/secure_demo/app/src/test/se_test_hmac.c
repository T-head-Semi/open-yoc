#include <string.h>
#include "se_device.h"
#include "se_hmac.h"
#include "yunit.h"

typedef struct {
        uint8_t in[256] __attribute__((aligned(64)));
        uint8_t *expect_out;
} hmac_para_t;

#define HMAC_KEY "key1234567!@#"
static uint8_t case_n = 0;


static int se_hmac_demo_single(se_sha_mode_t mode, const char *key, const char *in, uint8_t *out_exp )
{
	uint8_t sum[64];
    se_hmac_t hamc;
	uint32_t len;
	int ret;

	memset(sum, 0x00, sizeof(sum));
	ret = se_hmac_init(&hamc);
	CHECK_RET_WITH_RET(ret == 0, ret);

	ret = se_hmac_set_key(&hamc, (uint8_t *)key, strlen(key));
	CHECK_RET_WITH_RET(ret == 0, ret);

	ret = se_hmac_calc(&hamc, mode, (uint8_t *)in, strlen(in), sum, &len);
	CHECK_RET_WITH_RET(ret == 0, ret);

	se_hmac_uninit(&hamc);
	ret = memcmp((const void *)sum, (const void *)out_exp, len);
    	if (ret != 0) {
		printf("case %d failed!\n", case_n);
	}

	return ret;
}

static uint8_t result_exp_1[] = {
    0xd2, 0x2b, 0x9c, 0x5f, 0x77, 0xfd, 0x94, 0xca, 
    0x19, 0xa9, 0x22, 0xe4, 0xe9, 0x12, 0x5a, 0x86, 
    0x19, 0x66, 0xc1, 0xe0, 0x09, 0x42, 0x97, 0xdc, 
    0x70, 0xb0, 0x3c, 0x63, 0xa1, 0x57, 0x14, 0xf0, 
};
static uint8_t result_exp_2[] = {
    0x2e, 0x3b, 0x93, 0x46, 0xf0, 0x2b, 0x33, 0xe0, 
    0x75, 0x0f, 0x49, 0xf0, 0xb7, 0x7a, 0x54, 0xf9, 
    0xcd, 0x0d, 0xe7, 0xaf, 0x27, 0x51, 0x7f, 0xdc, 
    0x8c, 0x82, 0x09, 0xe9, 0x53, 0x21, 0x5e, 0x84, 
};
static uint8_t result_exp_3[] = {
    0x3a, 0xd3, 0x5c, 0x77, 0x7e, 0x94, 0x2d, 0x38, 
    0xec, 0x19, 0x97, 0x67, 0x87, 0xd7, 0x29, 0xcb, 
    0xd8, 0xd2, 0x17, 0x37, 0xc8, 0x2a, 0x00, 0x87, 
    0xa1, 0x0f, 0x7a, 0x7a, 0x10, 0xa2, 0x60, 0x2a, 
};
static uint8_t result_exp_4[] = {
    0x04, 0x29, 0x40, 0x6c, 0xb9, 0xa3, 0x4f, 0x20, 
    0xd2, 0x0e, 0x71, 0x8c, 0x44, 0x30, 0x9d, 0x93, 
    0xa2, 0x51, 0xe4, 0xc5, 0x36, 0x70, 0x77, 0x9f, 
    0x86, 0x53, 0x84, 0x26, 0x3a, 0xdc, 0x80, 0x0e, 
};
static uint8_t result_exp_5[] = {
    0x75, 0x10, 0x64, 0x91, 0x9d, 0xfb, 0x6a, 0x6d, 
    0xb5, 0x3e, 0xa5, 0xd1, 0xe3, 0x25, 0xf1, 0xba, 
    0xd6, 0x87, 0x3a, 0x77, 0xb6, 0xd0, 0x29, 0xf6, 
    0xe6, 0xdc, 0x3d, 0x96, 0x7c, 0xa5, 0xa8, 0x7b, 
};
static void se_test_hmac_demo(void)
{
    int ret = 0;
    int i;

    hmac_para_t param[] = {
		{"!", result_exp_1},
		{"sw11233", result_exp_2},
		{"wcw111312232133331!@#", result_exp_3},
		{"!@#@!@!111113112312212112321321323111", result_exp_4},
		{"!@#@!@112132132131!!@#@!@!3211sasds11!#@!2121#@!#", result_exp_5},
	};

    for(i = 0;i < 5; ++i) {
        ++case_n;
        ret = se_hmac_demo_single(SE_SHA_MODE_256, (const char *)HMAC_KEY, (const char *)param[i].in, param[i].expect_out);
        YUNIT_ASSERT_MSG_QA(ret == 0, "the hmac_sha256_calc is %d", ret);
    }
    
}

void se_test_hmac(void)
{
    /***************HMAC TEST START****************/

    add_yunit_test("hmac", &se_test_hmac_demo);

    /***************HMAC TEST END****************/
}

